<script>
    const API = "https://api.tabiland.app";
    const input = document.getElementById("name");
    const emailBox = document.getElementById("email");
    const statusBox = document.getElementById("status");
    const mailBox = document.getElementById("mail");

    function setInbox(name) {
      if (!name) return;
      emailBox.textContent = `${name}@tabiland.app`;
      statusBox.textContent = "Waiting for emails...";
      mailBox.innerHTML = "";
      localStorage.setItem("inbox", name);
    }

    input.addEventListener("input", () => {
      const name = input.value.trim();
      if (!name) {
        emailBox.textContent = "";
        statusBox.textContent = "";
        mailBox.innerHTML = "";
        return;
      }
      setInbox(name);
    });

    async function pollInbox() {
      const inbox = localStorage.getItem("inbox");
      if (!inbox) return;

      try {
        // âœ… FIX: Add ?timestamp=... to prevent browser caching
        const res = await fetch(`${API}/inbox/${inbox}?timestamp=${Date.now()}`);
        
        if (!res.ok) throw new Error("Network response was not ok");
        
        const emails = await res.json();

        if (!emails.length) {
          statusBox.textContent = "Waiting for emails...";
          return;
        }

        const mail = emails[0];
        statusBox.textContent = "ðŸ“¬ Email received!";
        
        // Show the latest email
        mailBox.innerHTML = `
          <b>From:</b> ${mail.from}<br>
          <b>Subject:</b> ${mail.subject}<br>
          <hr style="border: 0; border-top: 1px solid #334155; margin: 10px 0;">
          <div style="white-space: pre-wrap;">${mail.text || "(no text content)"}</div>
        `;
      } catch (e) {
        console.error(e);
        statusBox.textContent = "Error loading inbox";
      }
    }

    // Restore inbox on reload
    const saved = localStorage.getItem("inbox");
    if (saved) {
      input.value = saved;
      setInbox(saved);
    }

    // Poll every 3 seconds
    setInterval(pollInbox, 3000);
  </script>